<section class="section" #sectionRef>
  <div class="section-header">
    <div>
      <p class="eyebrow">Catalogo de productos</p>
      <h2>Navegacion rapida por categorias</h2>
    </div>
  </div>
  @if (error()) {
    <div class="card">
      <h3>No se pudo cargar el cat√°logo</h3>
      <p class="muted">{{ error() }}</p>
    </div>
  } @else {
    <div class="catalog-layout">
      <aside class="filters card">
        <h3>Filtros laterales</h3>
        <div class="filter-group">
          <label class="field-label" for="catalogo-search">Buscar</label>
          <input
            id="catalogo-search"
            type="search"
            placeholder="Ej. Tomate chonto"
            [value]="search()"
            (input)="setSearch($any($event.target).value)"
          />
        </div>
        <div class="filter-group">
          <label class="field-label" for="catalogo-sort">Ordenar por</label>
          <select id="catalogo-sort" [value]="sort()" (change)="setSort($any($event.target).value)">
            <option value="name">Nombre (A-Z)</option>
            <option value="price">Precio (menor a mayor)</option>
            <option value="trend_up">Tendencia (m√°s subi√≥)</option>
            <option value="trend_down">Tendencia (m√°s baj√≥)</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="field-label" for="catalogo-trend">Filtrar tendencia</label>
          <select id="catalogo-trend" [value]="trendFilter()" (change)="setTrendFilter($any($event.target).value)">
            <option value="all">Todas</option>
            <option value="up">Subi√≥</option>
            <option value="down">Baj√≥</option>
            <option value="neutral">Estable</option>
          </select>
        </div>
        <div class="filter-group">
          <p class="filter-title">Categorias</p>
          @for (category of categories(); track category) {
            <label class="checkbox">
              <input
                type="checkbox"
                [checked]="selectedCategories().has(category)"
                (change)="toggleCategory(category, $any($event.target).checked)"
              />
              <span>{{ category }}</span>
            </label>
          }
        </div>
      </aside>

      <div class="product-section">
        @if (loading()) {
          <div class="card">
            <p class="muted">Cargando productos‚ˇ¶</p>
          </div>
        } @else {
          <div class="product-results-header">
            <p class="muted">{{ filteredItems().length }} producto{{ filteredItems().length !== 1 ? 's' : '' }} encontrado{{ filteredItems().length !== 1 ? 's' : '' }}</p>
          </div>
          <div class="product-grid">
            @for (item of pagedItems(); track item.producto) {
              <article class="card product-card">
                <a
                  [routerLink]="['/producto', item.producto.toLowerCase()]"
                  class="product-link"
                  [attr.aria-label]="'Ver detalles de ' + item.producto"
                >
                  <div class="product-icon" aria-hidden="true">
                    <span>{{ iconFor(item.grupo_alimentos) }}</span>
                  </div>
                  <div class="product-body">
                    <div class="product-title">
                      <h4>{{ item.producto }}</h4>
                      <span class="tag">{{ item.grupo_alimentos }}</span>
                    </div>
                    <p class="price">$ {{ item.precioActual.toLocaleString('es-CO') }} / kg</p>
                    <p
                      class="trend"
                      [class.up]="trendFor(item) === 'up'"
                      [class.down]="trendFor(item) === 'down'"
                      [class.neutral]="trendFor(item) === 'neutral'"
                      [attr.aria-label]="'Tendencia: ' + trendText(item) + (changeLabel(item) ? ' ' + changeLabel(item) : '')"
                    >
                      <span class="trend-icon" aria-hidden="true">{{ trendIcon(item) }}</span>
                      {{ trendText(item) }} {{ changeLabel(item) }}
                    </p>
                  </div>
                </a>
              </article>
            }
            @if (pagedItems().length === 0) {
              <div class="card">
                <p class="muted">No se encontraron productos con los filtros seleccionados.</p>
              </div>
            }
          </div>
          @if (pageCount() > 1) {
            <nav class="pagination" aria-label="Paginaci√≥n de productos">
              <button
                class="btn btn-secondary btn-sm"
                [disabled]="page() === 1"
                (click)="setPage(page() - 1)"
                aria-label="P√°gina anterior"
              >
                Anterior
              </button>
              <div class="pagination-numbers">
                @for (p of getPaginationItems(); track $index) {
                  @if (p.kind === 'ellipsis') {
                    <span class="pagination-ellipsis">...</span>
                  } @else {
                    <button
                      class="btn btn-secondary btn-sm pagination-number"
                      [class.active]="page() === p.value"
                      [attr.aria-current]="page() === p.value ? 'page' : null"
                      (click)="setPage(p.value)"
                      [attr.aria-label]="'Ir a p√°gina ' + p.value"
                    >
                      {{ p.value }}
                    </button>
                  }
                }
              </div>
              <button
                class="btn btn-secondary btn-sm"
                [disabled]="page() === pageCount()"
                (click)="setPage(page() + 1)"
                aria-label="P√°gina siguiente"
              >
                Siguiente
              </button>
            </nav>
          }
        }
      </div>
    </div>
  }
</section>
